<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supernoba Exchange Terminal</title>
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* ... Existing CSS ... */
        :root {
            --bg-base: #0d1117;
            --bg-panel: #161b22;
            --bg-input: #21262d; 
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --buy: #238636;
            --sell: #da3633;
            --warning: #d29922;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        header {
            height: auto; min-height: 48px;
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 8px 16px; gap: 8px;
        }
        .header-row { display: flex; align-items: center; gap: 12px; width: 100%; }
        
        .logo { font-weight: bold; font-size: 1.1rem; color: var(--text-primary); text-decoration: none; }
        .logo span { color: var(--accent); }

        /* Config Controls */
        .config-input { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 0.75rem; }
        .config-label { font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }
        
        /* --- Grid & Panels --- */
        .grid-container {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr 320px; 
            grid-template-rows: 1fr 300px; /* Increased bottom height for Automation */
            gap: 1px;
            background-color: var(--border);
            overflow: hidden;
        }

        .panel { background-color: var(--bg-base); overflow: hidden; display: flex; flex-direction: column; }
        .panel-header { height: 32px; min-height: 32px; display: flex; align-items: center; padding: 0 12px; background-color: var(--bg-panel); font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border); }

        /* Left Column */
        .left-column { grid-column: 1; grid-row: 1 / span 2; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .orderbook-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        
        /* ... Orderbook CSS (Keep existing) ... */
        .orderbook-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; font-family: 'Consolas', monospace; table-layout: fixed; }
        .orderbook-table th { padding: 4px 8px; text-align: right; color: var(--text-secondary); font-weight: normal; }
        .orderbook-table th:first-child { text-align: left; }
        .orderbook-table td { padding: 2px 8px; text-align: right; position: relative; height: 20px; vertical-align: middle; z-index: 1; }
        .orderbook-table td:first-child { text-align: left; }
        .price-up { color: var(--buy); } .price-down { color: var(--sell); }
        .bar-bg { position: absolute; top: 1px; bottom: 1px; opacity: 0.35; z-index: -1; pointer-events: none; }
        .bar-ask { right: 0; background-color: var(--sell); } .bar-bid { left: 0; background-color: var(--buy); }
        .spread-info { text-align: center; padding: 6px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); font-size: 0.95rem; font-weight: bold; background: var(--bg-panel); display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); }

        /* Admin Panel */
        .admin-panel { flex: 1; border-top: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-base); min-height: 0; }
        .admin-log { flex: 1; overflow-y: auto; padding: 8px; font-family: 'Consolas', monospace; font-size: 0.7rem; color: #a0a0a0; white-space: pre-wrap; word-break: break-all; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #21262d; padding-bottom: 4px; }
        .log-entry.in { color: #58a6ff; } .log-entry.out { color: #7ee787; } .log-entry.err { color: #ff7b72; }

        /* Center Column */
        .center-column { grid-column: 2; grid-row: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); min-height: 0; overflow: hidden; }
        .chart-panel { flex: 2; position: relative; border-bottom: 1px solid var(--border); min-height: 0; overflow: hidden; }
        #tvChartContainer { width: 100%; height: 100%; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        
        .monitor-panel { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; min-height: 0; }
        .monitor-header { display: flex; justify-content: space-between; padding: 4px 8px; background: #161b22; font-size: 0.75rem; color: #8b949e; border-bottom: 1px solid #30363d; }
        .monitor-content { flex: 1; padding: 8px; overflow-y: auto; font-family: monospace; font-size: 0.7rem; color: #00ff00; }
        .blink { animation: blinker 0.5s linear infinite; color: #fff; background: #238636; padding: 0 4px; border-radius: 2px; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* Right Column */
        .orderform-panel { grid-column: 3; grid-row: 1 / span 2; border-left: 1px solid var(--border); }
        /* ... Tabs/Form CSS ... */
        .tabs { display: flex; background: var(--bg-panel); }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; }
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--accent); background: #1c2128; }
        .tab-btn.buy.active { color: var(--buy); border-bottom-color: var(--buy); }
        .tab-btn.sell.active { color: var(--sell); border-bottom-color: var(--sell); }
        .type-btn { flex: 1; padding: 6px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; border-radius: 4px; }
        .type-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }
        .form-section { padding: 16px; display: flex; flex-direction: column; gap: 16px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; }
        .input-control { width: 100%; background: var(--bg-input); border: 1px solid #30363d; color: white; padding: 8px 10px; border-radius: 4px; font-family: monospace; }
        .input-control:focus { outline: none; border-color: var(--text-secondary); }
        .order-btn { width: 100%; padding: 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 0.95rem; margin-top: 10px; }
        .btn-buy { background-color: var(--buy); } .btn-buy:hover { background-color: #2ea043; }
        .btn-sell { background-color: var(--sell); } .btn-sell:hover { background-color: #a02825; }

        /* Bottom Panel */
        .bottom-panel { grid-column: 2; grid-row: 2; border-top: 1px solid var(--border); display: flex; flex-direction: column; }
        .bottom-tabs { display: flex; gap: 20px; padding: 0 16px; border-bottom: 1px solid var(--border); background: var(--bg-panel); }
        .bottom-tab { padding: 8px 0; font-size: 0.85rem; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; }
        .bottom-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .panel-content { flex: 1; overflow: hidden; display: none; }
        .panel-content.active { display: flex; flex-direction: column; }
        
        .automation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; overflow-y: auto; }
        .auto-box { border: 1px solid var(--border); padding: 12px; border-radius: 4px; background: var(--bg-input); }
        .auto-box h4 { margin-bottom: 12px; color: var(--accent); font-size: 0.9rem; border-bottom: 1px solid var(--border); padding-bottom: 4px; }

        /* Action Buttons */
        .action-btn { padding: 2px 8px; border-radius: 3px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-secondary); cursor: pointer; font-size: 0.75rem; margin-right: 4px; }
        .action-btn:hover { color: var(--text-primary); border-color: var(--text-secondary); }
        .btn-cancel { color: var(--sell); border-color: rgba(218, 54, 51, 0.4); }
        /* Status */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #333; display: inline-block; margin-right: 6px; }
        .connected { background-color: var(--buy); box-shadow: 0 0 5px var(--buy); }
        .disconnected { background-color: var(--sell); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--bg-panel); padding: 24px; border-radius: 8px; width: 400px; border: 1px solid var(--border); }
        
        /* Symbol Badge */
        .symbol-badge { display: inline-block; padding: 4px 8px; margin: 2px; background: var(--buy); color: #fff; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        
        /* API Config Section */
        .api-config-section { padding: 8px; background: var(--bg-panel); border-bottom: 1px solid var(--border); }
        .api-config-row { display: flex; gap: 4px; margin-bottom: 4px; align-items: center; }
        .api-config-label { font-size: 0.7rem; color: var(--text-secondary); min-width: 60px; }
        .api-config-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: 3px 6px; border-radius: 3px; font-family: monospace; font-size: 0.7rem; }
        
        /* Monitor Split Layout */
        .monitor-split { display: flex; flex: 1; overflow: hidden; min-height: 0; }
        .monitor-left { flex: 1; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .monitor-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
    </style>
</head>
<body>
    <header>
        <div class="header-row">
            <a href="#" class="logo">SUPER<span>NOBA</span> <span style="font-size: 0.7rem; color: #666;">DEBUG_CLIENT</span></a>
            <div style="flex: 1;"></div>
            
            <!-- Connection Controls -->
            <div class="config-label">
                WS Endpoint:
                <input type="text" id="wsEndpoint" class="config-input" style="width: 500px;" value="wss://l2ptm85wub.execute-api.ap-northeast-2.amazonaws.com/production">
            </div>
            
            <label class="config-label">
                <input type="checkbox" id="chkTestMode" checked> Test Mode (Bypass JWT)
            </label>
            
            <button id="btnConnect" class="action-btn" style="padding: 4px 12px; font-weight: bold;" onclick="toggleConnection()">Connect</button>
            
            <div id="connectionStatus" style="font-size: 0.8rem; display: flex; align-items: center; color: var(--text-secondary); margin-left: 10px;">
                <span class="status-dot disconnected"></span> Disconnected
            </div>
        </div>
    </header>

    <div class="grid-container">
        <!-- [1] Left Column: Orderbook + Admin -->
        <div class="left-column">
            <!-- [1-Top] Orderbook -->
            <div class="orderbook-panel">
                <div class="panel-header">
                    <span>Order Book</span>
                    <span style="margin-left: auto; font-size: 0.75rem;" id="ob-symbol">TEST</span>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden;">
                    <table class="orderbook-table"><tbody id="ob-asks"></tbody></table>
                </div>
                <div class="spread-info">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="ob-last-price" style="font-size: 1.2rem; font-weight: bold;">0</span>
                        <span id="ob-change-rate" style="font-size: 0.85rem;">+0.00%</span>
                    </div>
                    <div style="display: flex; gap: 12px; font-size: 0.75rem; color: var(--text-secondary);">
                        <span id="ob-spread">Spread: -</span>
                        <span id="ob-timestamp">--:--:--</span>
                    </div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-start; overflow: hidden;">
                    <table class="orderbook-table"><tbody id="ob-bids"></tbody></table>
                </div>
            </div>

            <!-- [1-Bottom] Admin Dashboard (Symbol Manager) -->
            <div class="admin-panel">
                <div class="panel-header" style="background: #2d1b2e; color: #ff80ff;">
                     <span>üõ†Ô∏è Symbol Manager (Admin)</span>
                </div>
                <div style="padding: 8px; border-bottom: 1px solid var(--border);">
                    <!-- Symbol Actions -->
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                        <input type="text" id="newSymbol" class="config-input" style="flex: 1;" placeholder="Symbol (TEST)">
                        <button class="action-btn" onclick="addSymbol()">+ Add</button>
                        <button class="action-btn" onclick="removeSymbol()" style="color:red">- Del</button>
                    </div>
                    <button class="action-btn" style="width: 100%; text-align: center; margin-bottom: 4px;" onclick="listSymbols()">Ï¢ÖÎ™© Î™©Î°ù Ï°∞Ìöå (Refresh List)</button>
                    <div id="symbolList" style="font-size: 0.7rem; color: #888; overflow-x: auto; white-space: nowrap; padding: 4px; border: 1px solid #30363d; min-height: 28px; display: flex; flex-wrap: wrap; gap: 2px;">-</div>
                </div>
                <div id="adminLog" class="admin-log">
                    <div class="log-entry">System ready.</div>
                </div>
            </div>
        </div>

        <!-- [2] Center Column: Chart + Live Monitor -->
        <div class="center-column">
            <!-- [2-Top] Chart -->
            <div class="chart-panel">
                <div id="tvChartContainer"></div>
                <!-- Timeframe selector -->
                <div style="position: absolute; top: 12px; left: 12px; z-index: 20; display: flex; gap: 4px;">
                    <button class="action-btn" onclick="setTimeframe('1m')">1m</button>
                    <button class="action-btn" onclick="setTimeframe('3m')">3m</button>
                    <button class="action-btn" onclick="setTimeframe('5m')">5m</button>
                    <button class="action-btn" onclick="setTimeframe('15m')">15m</button>
                    <button class="action-btn" onclick="setTimeframe('30m')">30m</button>
                    <button class="action-btn" onclick="setTimeframe('1h')">1h</button>
                </div>
            </div>

            <!-- [2-Bottom] Real-time Data Monitor (Split: API Config | Stream) -->
            <div class="monitor-panel">
                <div class="monitor-header">
                    <span>üì° Data Stream Monitor</span>
                    <div style="display: flex; gap: 8px;">
                        <span id="indDepth" style="color: #666;">DEPTH ‚óè</span>
                        <span id="indCandle" style="color: #666;">CANDLE ‚óè</span>
                    </div>
                </div>
                
                <!-- Split Layout: Left = API Config, Right = Stream -->
                <div class="monitor-split">
                    <!-- LEFT: API Configuration -->
                    <div class="monitor-left">
                        <div class="api-config-section" style="flex: 1; overflow-y: auto;">
                            <div style="font-size: 0.75rem; color: var(--accent); margin-bottom: 8px; font-weight: bold;">‚öôÔ∏è API Configuration</div>
                            
                            <div class="api-config-row">
                                <span class="api-config-label">Admin API</span>
                                <input type="text" id="adminApiUrl" class="api-config-input" value="https://0eeto6kblk.execute-api.ap-northeast-2.amazonaws.com/admin/Supernoba-admin">
                            </div>
                            
                            <div class="api-config-row">
                                <span class="api-config-label">Order API</span>
                                <input type="text" id="orderApiUrl" class="api-config-input" value="https://4xs6g4w8l6.execute-api.ap-northeast-2.amazonaws.com/restV2/orders">
                            </div>
                            
                            <div class="api-config-row">
                                <span class="api-config-label">Chart API</span>
                                <input type="text" id="chartApiUrl" class="api-config-input" value="https://4xs6g4w8l6.execute-api.ap-northeast-2.amazonaws.com/restV2/chart">
                            </div>
                            
                            <div class="api-config-row">
                                <span class="api-config-label">API Key</span>
                                <input type="password" id="restApiKey" class="api-config-input" value="S0cLXAGtuza6T3GbYZ8TBbERqfdi5Xo1ilA914gf">
                            </div>
                            
                            <div style="margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px;">
                                <div class="api-config-row">
                                    <span class="api-config-label">Symbol</span>
                                    <input type="text" id="subSymbol" class="api-config-input" style="flex: 0.5;" value="TEST">
                                    <button class="action-btn" onclick="subscribeSymbol()">Subscribe</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Stream Monitor (Split into DEPTH | CANDLE) -->
                    <div class="monitor-right">
                        <div style="display: flex; flex: 1; overflow: hidden; min-height: 0;">
                            <!-- DEPTH Console -->
                            <div style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow: hidden;">
                                <div style="padding: 2px 6px; background: var(--sell); color: #fff; font-size: 0.65rem; font-weight: bold;">DEPTH</div>
                                <div id="depthMonitor" class="monitor-content" style="flex: 1; overflow-y: auto;">
                                </div>
                            </div>
                            <!-- CANDLE Console -->
                            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <div style="padding: 2px 6px; background: var(--buy); color: #fff; font-size: 0.65rem; font-weight: bold;">CANDLE</div>
                                <div id="candleMonitor" class="monitor-content" style="flex: 1; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- [3] Order Form Panel -->
        <div class="panel orderform-panel">
            <div class="tabs">
                <button class="tab-btn buy active" onclick="setSide('BUY')">Îß§Ïàò (Buy)</button>
                <button class="tab-btn sell" onclick="setSide('SELL')">Îß§ÎèÑ (Sell)</button>
            </div>
            
            <div class="form-section">
                <!-- Order Type (Highlighted) -->
                <div class="input-group">
                    <label>Ï£ºÎ¨∏ Ïú†Ìòï (Type)</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="type-btn active" id="btnTypeLimit" onclick="setOrderType('LIMIT')">ÏßÄÏ†ïÍ∞Ä (Limit)</button>
                        <button class="type-btn" id="btnTypeMarket" onclick="setOrderType('MARKET')">ÏãúÏû•Í∞Ä (Market)</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Í∞ÄÍ≤© (Price)</label>
                    <input type="number" id="inputPrice" class="input-control" value="100">
                </div>

                <div class="input-group">
                    <label>ÏàòÎüâ (Amount)</label>
                    <input type="number" id="inputQty" class="input-control" value="1">
                </div>

                <div class="input-group">
                    <label>Ï£ºÎ¨∏ Ï¥ùÏï°</label>
                    <input type="text" id="inputTotal" class="input-control" readonly style="background: transparent; border: none; text-align: right; padding-right: 0;" value="0 KRW">
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                    <span>Í∞ÄÎä• ÏûîÍ≥†</span>
                    <span>-</span> 
                </div>
                
                <!-- Order Conditions -->
                <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 0.75rem;">
                    <label class="config-label" style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" id="chkAON"> AON (Ï†ÑÎüâÏ≤¥Í≤∞)
                    </label>
                    <label class="config-label" style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" id="chkIOC"> IOC (Ï¶âÏãúÏ≤¥Í≤∞/Ï∑®ÏÜå)
                    </label>
                </div>

                <button id="btnOrder" class="order-btn btn-buy" onclick="submitOrder('ADD')">Îß§Ïàò Ï£ºÎ¨∏</button>
                
                <!-- Update Actions -->
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                    <div class="input-group">
                        <label>Target Order ID (Ï†ïÏ†ï/Ï∑®ÏÜå)</label>
                        <input type="text" id="targetOrderId" class="input-control" placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÑ†ÌÉù">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                         <button class="action-btn" style="flex: 1;" onclick="submitOrder('REPLACE')">Ï†ïÏ†ï (Replace)</button>
                         <button class="action-btn" style="flex: 1; color: var(--sell); border-color: var(--sell);" onclick="submitOrder('CANCEL')">Ï∑®ÏÜå (Cancel)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- [4] Bottom Panel (Open Orders) -->
        <div class="panel bottom-panel">
            <div class="bottom-tabs">
                <div class="bottom-tab active" onclick="setBottomTab('open')">ÎØ∏Ï≤¥Í≤∞ Ï£ºÎ¨∏ (Open Orders)</div>
                <div class="bottom-tab" onclick="setBottomTab('history')">Ï≤¥Í≤∞ ÎÇ¥Ïó≠ (Trade History)</div>
                <div class="bottom-tab" onclick="setBottomTab('balance')">ÏûêÏÇ∞ (Assets)</div>
            </div>
            
            <div class="order-list-container">
                <!-- VIEW: Open Orders -->
                <div id="view-open" style="display: block;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏãúÍ∞Ñ</th>
                                <th>Ï¢ÖÎ™©</th>
                                <th>Ïú†Ìòï</th>
                                <th>Î∞©Ìñ•</th>
                                <th>Í∞ÄÍ≤©</th>
                                <th>Ï£ºÎ¨∏ÏàòÎüâ</th>
                                <th>Ï≤¥Í≤∞ÏàòÎüâ</th>
                                <th>ÏÉÅÌÉú</th>
                                <th style="text-align: right;">Í¥ÄÎ¶¨</th>
                            </tr>
                        </thead>
                        <tbody id="openOrdersTable">
                            <!-- JS populated rows -->
                        </tbody>
                    </table>
                </div>

                <!-- VIEW: Trade History -->
                <div id="view-history" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏãúÍ∞Ñ</th>
                                <th>Ï¢ÖÎ™©</th>
                                <th>Î∞©Ìñ•</th>
                                <th>Ïú†Ìòï</th>
                                <th>Ï≤¥Í≤∞Í∞Ä</th>
                                <th>Ï≤¥Í≤∞Îüâ</th>
                                <th>Ï¥ùÏï°(Cost)</th>
                                <th>OrderID</th>
                            </tr>
                        </thead>
                        <tbody id="tradeHistoryTable">
                            <!-- JS populated rows -->
                        </tbody>
                    </table>
                </div>

                <!-- VIEW: Assets -->
                <div id="view-balance" style="display: none;">
                    <div style="padding: 20px; color: #888;">
                        ÏûêÏÇ∞ Ï†ïÎ≥¥ Ïó∞Îèô Ï§ÄÎπÑÏ§ë... (Supabase Balance)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay" style="display: flex;">
        <div class="modal">
            <h2 style="margin-bottom: 16px;">Debug Login</h2>
            <div class="input-group" style="margin-bottom: 16px;">
                <label>User ID</label>
                <input type="text" id="loginUserId" class="input-control" value="test-user-1" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <div class="input-group" style="margin-bottom: 16px;">
                <label>Admin Key (for Admin API)</label>
                <input type="password" id="loginAdminKey" class="input-control" placeholder="Enter Admin Key for symbol management" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <button class="order-btn btn-primary" style="background: var(--accent);" onclick="doLogin()">Ï†ëÏÜçÌïòÍ∏∞</button>
        </div>
    </div>

    <script>
        // --- State ---
        let isLoggedIn = false;  // Login guard flag
        
        const state = {
            symbol: 'TEST',
            userId: 'test-user-1',
            adminKey: '',
            side: 'BUY',
            type: 'LIMIT', 
            interval: '1m',
            ws: null,
            orders: [],       // Open Orders
            tradeHistory: [], // Filled/History
            isConnected: false,
            candleTestInterval: null
        };

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            initChart();
            updateTotalDisplay();
            // Add input listeners for total calculation
            document.getElementById('inputPrice').addEventListener('input', updateTotalDisplay);
            document.getElementById('inputQty').addEventListener('input', updateTotalDisplay);
            adminLog('System Ready. Click [Connect] to start.', 'in');
        });

        function updateTotalDisplay() {
            const price = parseFloat(document.getElementById('inputPrice').value) || 0;
            const qty = parseInt(document.getElementById('inputQty').value) || 0;
            document.getElementById('inputTotal').value = (price * qty).toLocaleString() + ' KRW';
        }

        function toggleConnection() {
            if(state.isConnected) {
                if(state.ws) state.ws.close();
            } else {
                connectWS();
            }
        }

        function doLogin() {
            const uid = document.getElementById('loginUserId').value;
            const adminKey = document.getElementById('loginAdminKey').value;
            if(uid) state.userId = uid;
            if(adminKey) state.adminKey = adminKey;
            
            isLoggedIn = true;  // Enable data loading
            document.getElementById('loginModal').style.display = 'none';
            
            // Start loading data after login
            connectWS();
            fetchChartData(state.symbol);
            adminLog('Î°úÍ∑∏Ïù∏ ÏôÑÎ£å: ' + state.userId, 'in');
        }

        // --- Utility: Get Admin Key ---
        function getAdminKey() {
            return state.adminKey;
        }

        // --- Logging ---
        function adminLog(msg, type = 'in') {
            const el = document.getElementById('adminLog');
            if(!el) return;
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.prepend(div);
            // Limit log entries
            while(el.children.length > 100) el.lastChild.remove();
        }
        const log = (msg) => adminLog(msg, 'in');

        function logDepth(msg) {
            const el = document.getElementById('depthMonitor');
            if(!el) return;
            const row = document.createElement('div');
            row.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.prepend(row);
            if(el.children.length > 30) el.lastChild.remove();
        }

        function logCandle(msg) {
            const el = document.getElementById('candleMonitor');
            if(!el) return;
            const row = document.createElement('div');
            row.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.prepend(row);
            if(el.children.length > 30) el.lastChild.remove();
        }

        function flashIndicator(id) {
            const el = document.getElementById(id);
            if(el) {
                el.style.color = '#0f0';
                el.style.textShadow = '0 0 5px #0f0';
                setTimeout(() => {
                    el.style.color = '#666';
                    el.style.textShadow = 'none';
                }, 200);
            }
        }

        // --- WebSocket ---
        function connectWS() {
            if(!isLoggedIn) {
                adminLog('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî', 'err');
                return;
            }
            
            let url = document.getElementById('wsEndpoint').value;
            
            // Add query parameters for authentication
            const params = new URLSearchParams();
            params.append('userId', state.userId);
            
            // Add testMode if checkbox is checked
            const testMode = document.getElementById('chkTestMode')?.checked;
            if(testMode) {
                params.append('testMode', 'true');
            }
            
            // Append params to URL
            url = url + (url.includes('?') ? '&' : '?') + params.toString();
            
            adminLog(`Connecting to ${url.substring(0, 80)}...`, 'out');
            
            try {
                state.ws = new WebSocket(url);
            } catch(e) {
                adminLog('WS Error: ' + e.message, 'err');
                retryConnection();
                return;
            }

            state.ws.onopen = () => {
                state.isConnected = true;
                updateStatus(true);
                adminLog('WS Connected', 'in');
                startHeartbeat();
                
                // Subscribe Main
                const subSym = document.getElementById('subSymbol').value;
                state.symbol = subSym;
                state.ws.send(JSON.stringify({ action: 'subscribe', main: subSym }));
            };

            state.ws.onmessage = (event) => {
                let msg;
                try {
                    msg = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                } catch(e) {
                    logMonitor(`Parse Error: ${e.message}`);
                    return;
                }
                handleMessage(msg);
            };

            state.ws.onclose = () => {
                state.isConnected = false;
                updateStatus(false);
                adminLog('WS Disconnected', 'err');
                stopHeartbeat();
                if (isLoggedIn) {
                   retryConnection();
                }
            };
            
            state.ws.onerror = (err) => {
                adminLog('WS Error occurred', 'err');
                // onclose will be called after onerror, so retries happen there
            };
        }

        let reconnectTimeout = null;
        function retryConnection() {
            if (reconnectTimeout) clearTimeout(reconnectTimeout);
            adminLog('Reconnecting in 3s...', 'warn');
            reconnectTimeout = setTimeout(() => {
                connectWS();
            }, 3000);
        }

        let heartbeatInterval = null;
        function startHeartbeat() {
            stopHeartbeat();
            heartbeatInterval = setInterval(() => {
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    // Send a ping to keep connection alive
                    state.ws.send(JSON.stringify({ action: 'ping' }));
                }
            }, 30000); // 30 seconds
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function subscribeSymbol() {
            const sym = document.getElementById('subSymbol').value;
            if(!sym) return;
            state.symbol = sym;
            document.getElementById('ob-symbol').innerText = sym;
            
            if(state.ws && state.isConnected) {
                state.ws.send(JSON.stringify({ action: 'subscribe', main: sym }));
                adminLog(`Subscribed to: ${sym}`, 'out');
            }
            fetchChartData(sym);
        }

        function handleMessage(msg) {
            // Depth data format from backend:
            // {"a":[],"b":[],"c":6.41,"e":"d","p":3638,"s":"TEST","t":1766197528304,"yc":-43.08}
            
            // Check for depth data (e === 'd' or has a/b arrays)
            if(msg.e === 'd' || (msg.a !== undefined && msg.b !== undefined)) {
                // This is depth data
                const text = `${msg.s || state.symbol} A:${msg.a?.length || 0} B:${msg.b?.length || 0}`;
                logDepth(text);
                flashIndicator('indDepth');
                renderOrderbook(msg);
                return;
            }
            
            // Candle data
            if(msg.e === 'candle' || msg.type === 'candle') {
                const text = `${msg.s || state.symbol} O:${msg.o} H:${msg.h} L:${msg.l} C:${msg.c}`;
                logCandle(text);
                flashIndicator('indCandle');
                updateChartWithCandle(msg);
                return;
            }
            
            if(msg.e === 'candle_close' || msg.type === 'candle_close') {
                const text = `CLOSE ${msg.s || state.symbol} O:${msg.o} C:${msg.c}`;
                logCandle(text);
                flashIndicator('indCandle');
                updateChartWithCandle(msg, true);
                return;
            }
            
            // Order Status Update (Private)
            if (msg.type === 'ORDER_STATUS' || msg.event === 'ORDER_STATUS') {
                const data = msg.data || msg;
                updateOrderLocally(data);
                
                // Log only important changes
                if(data.status === 'FILLED') {
                    // For specific fill event logging
                    // adminLog(`FILLED: ${data.filled_qty} @ ${data.filled_price}`, 'in');
                } else {
                    adminLog(`üìã Order: ${data.status} #${data.order_id?.substring(0, 15) || 'unknown'}`, 'in');
                }
                return;
            }
            
            // Fill Update (Private)
            if (msg.type === 'FILL') {
                handleFill(msg.data);
                adminLog(`FILL: ${msg.data.filled_qty} @ ${msg.data.filled_price}`, 'in');
                return;
            }
            
            // Ping/pong or unknown
            if(msg.type !== 'ping') {
                logMonitor(`MSG: ${JSON.stringify(msg).substring(0, 60)}`);
            }
        }

        function updateStatus(connected) {
            const el = document.getElementById('connectionStatus');
            const btn = document.getElementById('btnConnect');
            
            if(connected) {
                el.innerHTML = `<span class="status-dot connected"></span> Connected`;
                btn.innerText = 'Disconnect';
                btn.style.borderColor = 'var(--sell)';
                btn.style.color = 'var(--sell)';
            } else {
                el.innerHTML = `<span class="status-dot disconnected"></span> Disconnected`;
                btn.innerText = 'Connect';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text-secondary)';
            }
        }

        // --- UI Utils ---
        function setBottomTab(name) {
            // Update Tab UI
            document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Toggle Views
            document.getElementById('view-open').style.display = (name === 'open') ? 'block' : 'none';
            document.getElementById('view-history').style.display = (name === 'history') ? 'block' : 'none';
            document.getElementById('view-balance').style.display = (name === 'balance') ? 'block' : 'none';
        }

        // --- Order Logic ---
        function updateOrderLocally(orderData) {
            // Handle FILLED separately for History
            if (orderData.status === 'FILLED') {
                // Add to history
                state.tradeHistory.unshift({
                    timestamp: orderData.timestamp || Date.now(),
                    symbol: orderData.symbol,
                    side: orderData.side,
                    type: orderData.type,
                    price: orderData.filled_price,
                    quantity: orderData.filled_qty,
                    cost: (orderData.filled_qty * orderData.filled_price),
                    order_id: orderData.order_id
                });
                renderTradeHistory();
                
                // Update Open Orders (Accumulate fill)
                const idx = state.orders.findIndex(o => o.order_id === orderData.order_id);
                if (idx >= 0) {
                     const existing = state.orders[idx];
                     existing.filled_qty = (existing.filled_qty || 0) + orderData.filled_qty;
                     
                     // Check if fully filled (if we know original qty)
                     if (existing.quantity > 0 && existing.filled_qty >= existing.quantity) {
                         state.orders.splice(idx, 1); // Remove from Open
                     } else {
                         state.orders[idx] = existing; // Update
                     }
                }
            } 
            else if (orderData.status === 'ACCEPTED') {
                 // Add to Open Orders
                 state.orders.unshift({
                     ...orderData,
                     filled_qty: 0 // Reset fill for new order
                 });
            }
            else if (orderData.status === 'CANCELLED' || orderData.status === 'REJECTED') {
                 // Remove from Open Orders
                 const idx = state.orders.findIndex(o => o.order_id === orderData.order_id);
                 if (idx >= 0) state.orders.splice(idx, 1);
            }
            
            renderOpenOrders();
        }

        function renderTradeHistory() {
            const tbody = document.getElementById('tradeHistoryTable');
            if(!tbody) return;
            tbody.innerHTML = state.tradeHistory.map(t => `
                <tr>
                    <td>${new Date(t.timestamp).toLocaleTimeString()}</td>
                    <td>${t.symbol}</td>
                    <td class="${t.side==='BUY'?'price-up':'price-down'}">${t.side}</td>
                    <td>${t.type}</td>
                    <td>${t.price}</td>
                    <td>${t.quantity}</td>
                    <td>${t.cost.toLocaleString()}</td>
                    <td style="font-size:0.75rem; color:#666;">${t.order_id.substring(0,8)}...</td>
                </tr>
            `).join('');
        }

        function handleFill(fillData) {
            const idx = state.orders.findIndex(o => o.order_id === fillData.order_id);
            if (idx >= 0) {
                state.orders[idx].filled_qty = (state.orders[idx].filled_qty || 0) + fillData.filled_qty;
                if (state.orders[idx].filled_qty >= state.orders[idx].quantity) state.orders.splice(idx, 1);
                renderOpenOrders();
            }
        }

        async function submitOrder(action = 'ADD') {
            const user_id = state.userId;
            const url = document.getElementById('orderApiUrl').value;

            if(!url) {
                adminLog('Order API URL is not configured', 'err');
                return;
            }

            let payload = {
                action: action,
                user_id: user_id,
                symbol: state.symbol,
                side: state.side
            };

            const targetOrderId = document.getElementById('targetOrderId').value;
            const price = parseFloat(document.getElementById('inputPrice').value);
            const qty = parseInt(document.getElementById('inputQty').value);

            if (action === 'ADD') {
                payload.type = state.type; 
                payload.price = payload.type === 'MARKET' ? 0 : price;
                payload.quantity = qty;
                
                // Order Conditions (AON, IOC)
                const aon = document.getElementById('chkAON')?.checked;
                const ioc = document.getElementById('chkIOC')?.checked;
                if(aon || ioc) {
                    payload.conditions = {
                        all_or_none: aon || false,
                        immediate_or_cancel: ioc || false
                    };
                }
            } else if (action === 'REPLACE') {
                if(!targetOrderId) { alert('Select order to replace'); return; }
                payload.order_id = targetOrderId;
                payload.price = price;
                const deltaStr = prompt("Qty Delta:", "0");
                if(deltaStr === null) return;
                payload.qty_delta = parseInt(deltaStr);
            } else if (action === 'CANCEL') {
                 if(!targetOrderId) { alert('Select order to cancel'); return; }
                 payload.order_id = targetOrderId;
            }

            adminLog(`Sending ${action}...`, 'out');
            try {
                const headers = { 'Content-Type': 'application/json' };
                const apiKey = document.getElementById('restApiKey').value;
                if(apiKey) headers['x-api-key'] = apiKey;
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(res.ok) {
                    adminLog(`${action} OK: ${result.order_id || result.message || 'success'}`, 'in');
                } else {
                    // ÏãúÏû•Í∞Ä Ï£ºÎ¨∏ ÌäπÏàò ÏóêÎü¨ Ï≤òÎ¶¨
                    if(result.error === 'MARKET_NO_LIQUIDITY') {
                        adminLog('‚ùå ÏãúÏû•Í∞Ä Ï£ºÎ¨∏ Ïã§Ìå®: Ïò§ÎçîÎ∂ÅÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§', 'err');
                        alert('ÏãúÏû•Í∞Ä Ï£ºÎ¨∏ÏùÑ ÎÑ£ÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\nÏò§ÎçîÎ∂ÅÏóê Ìò∏Í∞ÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                    } else {
                        adminLog(`${action} Failed: ${result.error || res.status}`, 'err');
                    }
                }
            } catch(e) {
                adminLog(`Order Error: ${e.message}`, 'err');
            }
        }

        // --- Admin / Symbol Manager ---
        async function listSymbols() {
            const endpoint = document.getElementById('adminApiUrl').value;
            const adminKey = getAdminKey();
            const el = document.getElementById('symbolList');
            el.innerHTML = '<span style="color:#888;">Loading...</span>';
            
            try {
                const headers = {};
                if(adminKey) headers['Authorization'] = adminKey;
                
                const res = await fetch(endpoint, { headers });
                const json = await res.json();
                
                // Render as badges
                const symbols = json.symbols || [];
                if(symbols.length > 0) {
                    el.innerHTML = symbols.map(s => 
                        `<span class="symbol-badge">${s}</span>`
                    ).join('');
                } else {
                    el.innerHTML = '<span style="color:#888;">No active symbols</span>';
                }
                adminLog(`Found ${symbols.length} symbols`, 'in');
            } catch(e) {
                el.innerHTML = '<span style="color:#ff7b72;">Error: ' + e.message + '</span>';
                adminLog('List symbols error: ' + e.message, 'err');
            }
        }

        async function addSymbol() {
            const sym = document.getElementById('newSymbol').value.trim().toUpperCase();
            if(!sym) { 
                adminLog('Enter a symbol name', 'err');
                return; 
            }
            const endpoint = document.getElementById('adminApiUrl').value;
            const adminKey = getAdminKey();
            
            if(!adminKey) {
                adminLog('Admin Key required for this operation', 'err');
                return;
            }
            
            adminLog(`Adding symbol: ${sym}...`, 'out');
            
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', 
                        'Authorization': adminKey
                    },
                    body: JSON.stringify({ symbol: sym })
                });
                const json = await res.json();
                
                if(res.ok) {
                    adminLog(`Symbol added: ${json.symbol} - ${json.message}`, 'in');
                    listSymbols();
                } else {
                    adminLog(`Failed: ${json.error || res.status}`, 'err');
                }
            } catch(e) {
                adminLog('Add symbol error: ' + e.message, 'err');
            }
        }

        async function removeSymbol() {
            const sym = document.getElementById('newSymbol').value.trim().toUpperCase();
            if(!sym) { 
                adminLog('Enter a symbol name to delete', 'err');
                return; 
            }
            const endpoint = document.getElementById('adminApiUrl').value;
            const adminKey = getAdminKey();
            
            if(!adminKey) {
                adminLog('Admin Key required for this operation', 'err');
                return;
            }
            
            if(!confirm(`Delete symbol "${sym}"?`)) return;
            
            adminLog(`Removing symbol: ${sym}...`, 'out');
            
            try {
                // Use DELETE method with symbol in URL path
                const res = await fetch(`${endpoint}/${sym}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminKey }
                });
                const json = await res.json();
                
                if(res.ok) {
                    adminLog(`Symbol removed: ${sym} - ${json.message}`, 'in');
                    listSymbols();
                } else {
                    adminLog(`Failed: ${json.error || res.status}`, 'err');
                }
            } catch(e) {
                adminLog('Remove symbol error: ' + e.message, 'err');
            }
        }

        // --- UI Utils ---
        /* setBottomTab moved to top of Order Logic for grouping */

        function setTimeframe(tf) {
            state.interval = tf;
            activeAggCandle = null; // Reset aggregation cache
            fetchChartData(state.symbol);
        }
        
        function setOrderType(type) { 
            state.type = type; 
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btnType${type.charAt(0)+type.slice(1).toLowerCase()}`).classList.add('active');
            const px = document.getElementById('inputPrice');
             if(type === 'MARKET') { px.disabled=true; px.value=''; px.placeholder='Market'; }
             else { px.disabled=false; px.placeholder=''; }
        }
        
        function setSide(side) {
            state.side = side;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn.${side.toLowerCase()}`).classList.add('active');
            const btn = document.getElementById('btnOrder');
            btn.className = `order-btn btn-${side.toLowerCase()}`;
            btn.innerText = (side === 'BUY') ? 'Îß§Ïàò Ï£ºÎ¨∏' : 'Îß§ÎèÑ Ï£ºÎ¨∏';
        }

        // --- Chart ---
        let chart, candleSeries;
        function initChart() {
             const el = document.getElementById('tvChartContainer');
            if(window.LightweightCharts) {
                el.innerHTML = '';
                chart = LightweightCharts.createChart(el, { 
                    layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
                    grid: { vertLines: { color: '#21262d'}, horzLines: { color: '#21262d'} },
                    timeScale: { timeVisible: true, secondsVisible: false },
                });
                candleSeries = chart.addCandlestickSeries({
                    upColor: '#238636',
                    downColor: '#da3633',
                    borderUpColor: '#238636',
                    borderDownColor: '#da3633',
                    wickUpColor: '#238636',
                    wickDownColor: '#da3633',
                });
                fetchChartData(state.symbol);
                window.addEventListener('resize', () => chart.resize(el.offsetWidth, el.offsetHeight));
                // Initial resize
                setTimeout(() => chart.resize(el.offsetWidth, el.offsetHeight), 100);
            }
        }

        async function fetchChartData(symbol) {
             if(!isLoggedIn) {
                 adminLog('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî', 'err');
                 return;
             }
             const url = document.getElementById('chartApiUrl').value;
             if(!url) {
                 log('Chart API URL not configured');
                 return;
             }
             try {
                 const res = await fetch(`${url}?symbol=${symbol}&interval=${state.interval}&limit=500`);
                 const json = await res.json();
                 if(json.data && json.data.length > 0) {
                    const d = json.data.sort((a,b) => a.time - b.time).map(x => ({
                        time: x.time, 
                        open: parseFloat(x.open), 
                        high: parseFloat(x.high), 
                        low: parseFloat(x.low), 
                        close: parseFloat(x.close)
                    }));
                    candleSeries.setData(d);
                    log(`Chart loaded: ${d.length} candles`);
                 } else {
                    log('No chart data available');
                 }
             } catch(e) { log('Chart Load Err: ' + e.message); }
        }

        // Track active candle for multi-minute aggregation
        let activeAggCandle = null; // { time, open, high, low, close }
        
        function updateChartWithCandle(candle, isClosed = false) {
            if(!candleSeries) return;
            
            // Get interval in seconds
            const intervalSeconds = {
                '1m': 60, '3m': 180, '5m': 300, '10m': 600, '15m': 900, '30m': 1800, '1h': 3600
            }[state.interval] || 60;
            
            // Use epoch time if available, otherwise parse t
            let rawTime = candle.t_epoch || candle.time;
            if(!rawTime && candle.t) {
                // Parse YYYYMMDDHHmm format
                const t = candle.t;
                if(t.length === 12) {
                    const y = parseInt(t.slice(0, 4));
                    const m = parseInt(t.slice(4, 6)) - 1;
                    const d = parseInt(t.slice(6, 8));
                    const h = parseInt(t.slice(8, 10));
                    const min = parseInt(t.slice(10, 12));
                    // KST to UTC
                    rawTime = Math.floor(Date.UTC(y, m, d, h, min) / 1000) - (9 * 3600);
                }
            }
            
            if(!rawTime) return;
            
            // Detect Milliseconds vs Seconds (Epoch 2025 is ~1.7e9 sec, ~1.7e12 ms)
            if (rawTime > 1000000000000) {
                rawTime = Math.floor(rawTime / 1000);
            }
            
            // Normalize epoch to interval boundary
            const alignedTime = Math.floor(rawTime / intervalSeconds) * intervalSeconds;
            
            // Get incoming candle OHLC
            const inOpen = parseFloat(candle.o);
            const inHigh = parseFloat(candle.h);
            const inLow = parseFloat(candle.l);
            const inClose = parseFloat(candle.c);
            
            // Multi-minute aggregation: accumulate within the same interval window
            if(intervalSeconds > 60) {
                if(!activeAggCandle || activeAggCandle.time !== alignedTime) {
                    // New interval window - start fresh with TradingView property names
                    activeAggCandle = { 
                        time: alignedTime, 
                        open: inOpen, 
                        high: inHigh, 
                        low: inLow, 
                        close: inClose 
                    };
                } else {
                    // Same window - update high/low/close (keep original open)
                    activeAggCandle.high = Math.max(activeAggCandle.high, inHigh);
                    activeAggCandle.low = Math.min(activeAggCandle.low, inLow);
                    activeAggCandle.close = inClose;
                }
                
                // TradingView expects: { time, open, high, low, close }
                candleSeries.update(activeAggCandle);
            } else {
                // 1-minute interval: use directly
                candleSeries.update({
                    time: alignedTime,
                    open: inOpen,
                    high: inHigh,
                    low: inLow,
                    close: inClose
                });
            }
        }

        function renderOpenOrders() {
             const tbody = document.getElementById('openOrdersTable');
             tbody.innerHTML = state.orders.map(o => `
                <tr onclick="document.getElementById('targetOrderId').value='${o.order_id}'">
                    <td>${new Date(o.timestamp||0).toLocaleTimeString()}</td>
                    <td>${o.symbol}</td>
                    <td>${o.type}</td>
                    <td class="${o.side==='BUY'?'price-up':'price-down'}">${o.side}</td>
                    <td>${o.price}</td>
                    <td>${o.quantity}</td>
                    <td>${o.filled_qty||0}</td>
                    <td>${o.status}</td>
                    <td><button class="action-btn btn-cancel" onclick="event.stopPropagation(); document.getElementById('targetOrderId').value='${o.order_id}'; submitOrder('CANCEL')">X</button></td>
                </tr>
             `).join('');
        }

        function renderOrderbook(data) {
             // Data format: {"a":[],"b":[],"c":6.41,"e":"d","p":3638,"s":"TEST","t":1766197528304,"yc":-43.08}
             const asks = (data.a || []).slice(0,10).reverse();
             const bids = (data.b || []).slice(0,10);
             
             // Update last price (p = price, c = change rate)
             if(data.p) {
                 document.getElementById('ob-last-price').innerText = parseFloat(data.p).toLocaleString();
             }
             
             // Update change rate display
             const changeEl = document.getElementById('ob-change-rate');
             if(changeEl && data.c !== undefined) {
                 const changeVal = parseFloat(data.c);
                 changeEl.innerText = `${changeVal >= 0 ? '+' : ''}${changeVal.toFixed(2)}%`;
                 changeEl.className = changeVal >= 0 ? 'price-up' : 'price-down';
             }
             
             // Update timestamp display (convert ms to readable time)
             const timeEl = document.getElementById('ob-timestamp');
             if(timeEl && data.t) {
                 const ts = data.t > 1000000000000 ? data.t : data.t * 1000; // Handle sec vs ms
                 timeEl.innerText = new Date(ts).toLocaleTimeString();
             }
            
             // Calculate spread
             const bestAsk = asks.length ? parseFloat(asks[asks.length-1][0]) : 0;
             const bestBid = bids.length ? parseFloat(bids[0][0]) : 0;
             if(bestAsk && bestBid) {
                 const spr = (bestAsk - bestBid).toFixed(2);
                 document.getElementById('ob-spread').innerText = `Spread: ${spr}`;
             }

             // Render asks (sell orders) - render with bars
             const maxAskQty = asks.reduce((max, r) => Math.max(max, parseFloat(r[1] || 0)), 0) || 1;
             document.getElementById('ob-asks').innerHTML = asks.map(r => {
                 const price = parseFloat(r[0]).toFixed(2);
                 const qty = Math.floor(parseFloat(r[1]));
                 const pct = (parseFloat(r[1]) / maxAskQty * 100).toFixed(1);
                 return `<tr><td class="price-down">${price}</td><td>${qty}</td><td><div class="bar-bg bar-ask" style="width:${pct}%"></div></td></tr>`;
             }).join('');
             
             // Render bids (buy orders)
             const maxBidQty = bids.reduce((max, r) => Math.max(max, parseFloat(r[1] || 0)), 0) || 1;
             document.getElementById('ob-bids').innerHTML = bids.map(r => {
                 const price = parseFloat(r[0]).toFixed(2);
                 const qty = Math.floor(parseFloat(r[1]));
                 const pct = (parseFloat(r[1]) / maxBidQty * 100).toFixed(1);
                 return `<tr><td class="price-up">${price}</td><td>${qty}</td><td><div class="bar-bg bar-bid" style="width:${pct}%"></div></td></tr>`;
             }).join('');
        }
    </script>
</body>
</html>
