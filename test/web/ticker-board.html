<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supernoba Ï†ÑÍ¥ëÌåê + Ìò∏Í∞ÄÏ∞Ω</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --danger: #f85149;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 20px; }
        header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--accent), #a371f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .connect-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .connect-form input {
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
            min-width: 300px;
        }
        .connect-form button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-connect { background: var(--success); color: #000; }
        .btn-disconnect { background: var(--danger); color: #fff; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); }
        .status-dot.connected { background: var(--success); }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .panel h2 { font-size: 1rem; margin-bottom: 12px; }

        .symbol-input {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .symbol-input input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
        }
        .symbol-input button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-main { background: var(--accent); color: #000; }
        .btn-sub { background: var(--success); color: #000; }

        .badge {
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 0.85rem;
        }

        .orderbook {
            background: var(--bg-input);
            border-radius: 8px;
            overflow: hidden;
        }

        .ob-header {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .ob-row {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .ob-row .price.ask { color: var(--danger); }
        .ob-row .price.bid { color: var(--success); }
        .ob-row .qty { text-align: right; }

        .spread-row {
            text-align: center;
            padding: 12px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        .spread-row .price { font-size: 1.2rem; font-weight: bold; }
        .spread-row .change { font-size: 0.9rem; margin-left: 10px; }
        .change.up { color: var(--success); }
        .change.down { color: var(--danger); }

        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .ticker-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            position: relative;
            transition: transform 0.2s;
        }
        .ticker-card:hover { transform: translateY(-2px); }
        .ticker-card .symbol { font-size: 1rem; font-weight: bold; margin-bottom: 8px; }
        .ticker-card .price-row { display: flex; justify-content: space-between; align-items: baseline; }
        .ticker-card .current-price { font-size: 1.2rem; font-weight: bold; }
        .ticker-card .change-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .ticker-card .change-badge.up { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .ticker-card .change-badge.down { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
        .ticker-card .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
        }
        .empty-ticker {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
            grid-column: 1 / -1;
        }

        .log-panel {
            margin-top: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }
        .log-container {
            background: var(--bg-input);
            border-radius: 4px;
            height: 150px;
            overflow-y: auto;
            padding: 8px;
            font-family: monospace;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Supernoba Main/Sub Ï†ÑÍ¥ëÌåê</h1>
        </header>

        <div class="status-bar">
            <div class="connect-form">
                <input type="text" id="wsEndpoint" value="wss://l2ptm85wub.execute-api.ap-northeast-2.amazonaws.com/production/" placeholder="WebSocket Endpoint">
                <button class="btn-connect" onclick="connect()">Ïó∞Í≤∞</button>
                <button class="btn-disconnect" onclick="disconnect()">Ìï¥Ï†ú</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div id="statusDot" class="status-dot"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>

        <div class="main-layout">
            <!-- Ìò∏Í∞ÄÏ∞Ω (Main) -->
            <div class="panel">
                <h2>üìä Ìò∏Í∞ÄÏ∞Ω (Main - 1Í∞úÎßå)</h2>
                <div class="symbol-input">
                    <input type="text" id="mainSymbol" value="TEST" placeholder="Ïã¨Î≥º">
                    <button class="btn-main" onclick="subscribeMain()">Íµ¨ÎèÖ</button>
                </div>
                <div class="badge" id="mainBadge">Íµ¨ÎèÖ Ï§ë: ÏóÜÏùå</div>
                <div class="orderbook">
                    <div class="ob-header">
                        <span>Í∞ÄÍ≤©</span>
                        <span style="text-align: right;">ÏàòÎüâ</span>
                        <span style="text-align: right;">Ï¥ùÏï°</span>
                    </div>
                    <div id="asksList"></div>
                    <div class="spread-row">
                        <span class="price" id="currentPrice">-</span>
                        <span class="change" id="changeRate">-</span>
                    </div>
                    <div id="bidsList"></div>
                </div>
            </div>

            <!-- Ï†ÑÍ¥ëÌåê (Sub) -->
            <div class="panel">
                <h2>üìà Ï†ÑÍ¥ëÌåê (Sub - Î¨¥Ï†úÌïú)</h2>
                <div class="symbol-input">
                    <input type="text" id="subSymbols" placeholder="ÏΩ§Îßà Íµ¨Î∂Ñ: AAPL,GOOGL,TSLA">
                    <button class="btn-sub" onclick="subscribeSub()">Ï∂îÍ∞Ä</button>
                </div>
                <div id="tickerGrid" class="ticker-grid">
                    <div class="empty-ticker">Sub Ïã¨Î≥ºÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>
                </div>
            </div>
        </div>

        <div class="log-panel">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Î©îÏãúÏßÄ Î°úÍ∑∏</span>
                <button onclick="document.getElementById('logContainer').innerHTML=''" style="font-size: 0.75rem; padding: 2px 8px;">ÏßÄÏö∞Í∏∞</button>
            </div>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentMainSymbol = null;
        let subSymbols = new Set();
        let tickerData = {};

        function log(msg) {
            const el = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div>[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function connect() {
            const endpoint = document.getElementById('wsEndpoint').value;
            if (!endpoint) return;

            log('Ïó∞Í≤∞ ÏãúÎèÑ...');
            ws = new WebSocket(endpoint);

            ws.onopen = () => {
                updateStatus(true);
                log('‚úÖ Ïó∞Í≤∞Îê®');
            };

            ws.onclose = () => {
                updateStatus(false);
                log('‚ùå Ïó∞Í≤∞ Ìï¥Ï†ú');
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    log(`Raw: ${event.data}`);
                }
            };
        }

        function disconnect() {
            if (ws) { ws.close(); ws = null; }
            currentMainSymbol = null;
            subSymbols.clear();
            tickerData = {};
            updateMainBadge();
            renderTickers();
        }

        function updateStatus(connected) {
            document.getElementById('statusDot').className = connected ? 'status-dot connected' : 'status-dot';
            document.getElementById('statusText').textContent = connected ? 'Connected' : 'Disconnected';
        }

        function handleMessage(msg) {
            if (msg.e === 'd') {
                // Depth (Main)
                log(`DEPTH ${msg.s}: ${msg.b?.length || 0} bids, ${msg.a?.length || 0} asks`);
                renderOrderbook(msg);
            } else if (msg.e === 't') {
                // Ticker (Sub)
                log(`TICKER ${msg.s}: ${msg.p} (${msg.c}%)`);
                tickerData[msg.s] = { p: msg.p, c: msg.c, yc: msg.yc };
                renderTickers();
            } else if (msg.message === 'Forbidden') {
                // ping ÏùëÎãµ Î¨¥Ïãú
            } else {
                log(JSON.stringify(msg));
            }
        }

        function subscribeMain() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Î®ºÏ†Ä Ïó∞Í≤∞ÌïòÏÑ∏Ïöî');
                return;
            }
            const symbol = document.getElementById('mainSymbol').value.toUpperCase();
            if (!symbol) return;

            // Ïã†Î≤ÑÏ†Ñ ÌòïÏãùÏúºÎ°ú Ï†ÑÏÜ°
            ws.send(JSON.stringify({ action: 'subscribe', main: symbol }));
            currentMainSymbol = symbol;
            updateMainBadge();
            log(`Main Íµ¨ÎèÖ: ${symbol}`);
        }

        function subscribeSub() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Î®ºÏ†Ä Ïó∞Í≤∞ÌïòÏÑ∏Ïöî');
                return;
            }
            const input = document.getElementById('subSymbols').value.toUpperCase();
            if (!input) return;

            const symbols = input.split(',').map(s => s.trim()).filter(s => s);
            
            // Ïã†Î≤ÑÏ†Ñ ÌòïÏãùÏúºÎ°ú Ï†ÑÏÜ°
            ws.send(JSON.stringify({ action: 'subscribe', sub: symbols }));
            symbols.forEach(s => { subSymbols.add(s); tickerData[s] = tickerData[s] || { p: 0, c: 0, yc: 0 }; });
            document.getElementById('subSymbols').value = '';
            renderTickers();
            log(`Sub Íµ¨ÎèÖ: ${symbols.join(', ')}`);
        }

        function removeSub(symbol) {
            subSymbols.delete(symbol);
            delete tickerData[symbol];
            renderTickers();
        }

        function updateMainBadge() {
            document.getElementById('mainBadge').textContent = currentMainSymbol ? `Íµ¨ÎèÖ Ï§ë: ${currentMainSymbol}` : 'Íµ¨ÎèÖ Ï§ë: ÏóÜÏùå';
        }

        function renderOrderbook(data) {
            const priceEl = document.getElementById('currentPrice');
            const changeEl = document.getElementById('changeRate');
            
            if (data.p) priceEl.textContent = data.p.toLocaleString();
            if (data.c !== undefined) {
                const sign = data.c >= 0 ? '+' : '';
                changeEl.textContent = `${sign}${data.c.toFixed(2)}%`;
                changeEl.className = `change ${data.c >= 0 ? 'up' : 'down'}`;
            }

            const asks = (data.a || []).slice(0, 10).reverse();
            document.getElementById('asksList').innerHTML = asks.map(a => `
                <div class="ob-row">
                    <span class="price ask">${a[0].toLocaleString()}</span>
                    <span class="qty">${a[1]}</span>
                    <span class="qty">${(a[0] * a[1]).toLocaleString()}</span>
                </div>
            `).join('') || '<div class="ob-row"><span>-</span></div>';

            const bids = (data.b || []).slice(0, 10);
            document.getElementById('bidsList').innerHTML = bids.map(b => `
                <div class="ob-row">
                    <span class="price bid">${b[0].toLocaleString()}</span>
                    <span class="qty">${b[1]}</span>
                    <span class="qty">${(b[0] * b[1]).toLocaleString()}</span>
                </div>
            `).join('') || '<div class="ob-row"><span>-</span></div>';
        }

        function renderTickers() {
            const grid = document.getElementById('tickerGrid');
            if (subSymbols.size === 0) {
                grid.innerHTML = '<div class="empty-ticker">Sub Ïã¨Î≥ºÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>';
                return;
            }

            grid.innerHTML = Array.from(subSymbols).map(symbol => {
                const d = tickerData[symbol] || { p: 0, c: 0, yc: 0 };
                const isUp = d.c >= 0;
                return `
                    <div class="ticker-card">
                        <button class="remove-btn" onclick="removeSub('${symbol}')">√ó</button>
                        <div class="symbol">${symbol}</div>
                        <div class="price-row">
                            <span class="current-price">${d.p ? d.p.toLocaleString() : '-'}</span>
                            <span class="change-badge ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${d.c.toFixed(2)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        renderTickers();
    </script>
</body>
</html>
